{% extends "base.html" %}

{% block title %}{{ product.title }} | NutriCoreIQ{% endblock %}

{% block content %}
<div class="container product-detail-wrapper">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <!-- Заголовок и поле поиска на одном уровне -->
            <div class="d-flex flex-column flex-md-row align-items-center justify-content-between mb-5 mt-3">
                <h1 class="mb-0">
                    {{ product.title }}
                    <span class="custom-info-icon">
                        <span class="question-icon">?</span>
                        <span class="custom-tooltip">Все значения нутриентов указаны в расчете на 100 г продукта</span>
                    </span>
                </h1>
                <div class="search-wrapper mt-2 mt-md-0 d-flex justify-content-md-end">
                    <form id="productDetailSearchForm" class="search-container">
                        <input type="text" name="query" id="productDetailQuery" class="form-control search-input compact-search"
                               placeholder="Поиск продукта"
                               autocomplete="off">
                        <span class="search-tooltip">Введите название продукта для анализа</span>
                        <div id="productDetailSearchResults" class="autocomplete-dropdown"></div>
                    </form>
                </div>
            </div>
            <div id="productDetailSearchError" class="alert alert-danger d-none mt-3"></div>

            <!-- Питательные вещества -->
            <div class="nutrient-grid">
                <div class="nutrient-group">
                    <div class="nutrient-group-inner">
                        <!-- Белки -->
                        {% if product.proteins.total|default(0) != 0 %}
                        <div class="nutrient-category">
                            <h2 class="category-header">
                                <span class="nutrient-name">Белки</span>
                            </h2>
                            <div class="nutrient-amount">{{ product.proteins.total|default(0)|round(2) }} <span class="unit">г</span></div>
                            {% if product.proteins.amino_acids %}
                            <div class="sub-category">
                                <div class="text-muted small mb-2">в том числе аминокислоты:</div>
                                <div class="ms-3">
                                    {% for type in ['nonessential', 'essential', 'cond_essential'] %}
                                        {% if product.proteins.amino_acids[type] %}
                                        <div class="nutrient-item">
                                            <span class="nutrient-name">
                                                {{ {'nonessential': 'заменимые', 'essential': 'незаменимые', 'cond_essential': 'условнонезаменимые'}[type] }}:
                                            </span>
                                            <span class="nutrient-amount">
                                                {{ (product.proteins.amino_acids[type] / 1000)|round(3) }} <span class="unit">г</span>
                                            </span>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Жиры -->
                        {% if product.fats and product.fats.total|default(0) != 0 %}
                        <div class="nutrient-category">
                            <h2 class="category-header">
                                <span class="nutrient-name">Жиры</span>
                            </h2>
                            <div class="nutrient-amount">{{ product.fats.total|default(0)|round(3) }} <span class="unit">г</span></div>
                            {% if product.fats.breakdown.saturated or product.fats.breakdown.monounsaturated or product.fats.breakdown.polyunsaturated %}
                            <div class="sub-category">
                                <div class="text-muted small mb-2">в том числе:</div>
                                <div class="ms-3">
                                    {% if product.fats.breakdown.saturated %}
                                    <div class="nutrient-item">
                                        <span class="nutrient-name">насыщенные:</span>
                                        <span class="nutrient-amount">{{ product.fats.breakdown.saturated|round(3) }} <span class="unit">г</span></span>
                                    </div>
                                    {% endif %}
                                    {% if product.fats.breakdown.monounsaturated %}
                                    <div class="nutrient-item">
                                        <span class="nutrient-name">мононенасыщенные:</span>
                                        <span class="nutrient-amount">{{ product.fats.breakdown.monounsaturated|round(3) }} <span class="unit">г</span></span>
                                    </div>
                                    {% endif %}
                                    {% if product.fats.breakdown.polyunsaturated %}
                                    <div class="nutrient-item">
                                        <span class="nutrient-name">полиненасыщенные:</span>
                                        <span class="nutrient-amount">{{ product.fats.breakdown.polyunsaturated.total|round(3) }} <span class="unit">г</span></span>
                                    </div>
                                    {% if product.fats.breakdown.polyunsaturated.omega3 or product.fats.breakdown.polyunsaturated.omega6 %}
                                    <div class="sub-category">
                                        <div class="text-muted small mb-2">из них:</div>
                                        <div class="ms-2">
                                            {% if product.fats.breakdown.polyunsaturated.omega3 %}
                                            <div class="nutrient-item">
                                                <span class="nutrient-name">Омега-3:</span>
                                                <span class="nutrient-amount">{{ product.fats.breakdown.polyunsaturated.omega3|round(2) }} <span class="unit">г</span></span>
                                            </div>
                                            {% endif %}
                                            {% if product.fats.breakdown.polyunsaturated.omega6 %}
                                            <div class="nutrient-item">
                                                <span class="nutrient-name">Омега-6:</span>
                                                <span class="nutrient-amount">{{ product.fats.breakdown.polyunsaturated.omega6|round(2) }} <span class="unit">г</span></span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Углеводы -->
                        {% if product.carbs and product.carbs.total|default(0) != 0 %}
                        <div class="nutrient-category">
                            <h2 class="category-header">
                                <span class="nutrient-name">Углеводы</span>
                            </h2>
                            <div class="nutrient-amount">{{ product.carbs.total|default(0)|round(2) }} <span class="unit">г</span></div>
                            {% if product.carbs.breakdown.fiber or product.carbs.breakdown.sugar %}
                            <div class="sub-category">
                                <div class="text-muted small mb-2">в том числе:</div>
                                <div class="ms-3">
                                    {% for carb in ['fiber', 'sugar'] %}
                                        {% if product.carbs.breakdown[carb] %}
                                        <div class="nutrient-item">
                                            <span class="nutrient-name">{{ {'fiber': 'клетчатка', 'sugar': 'сахар'}[carb] }}:</span>
                                            <span class="nutrient-amount">{{ product.carbs.breakdown[carb]|round(2) }} <span class="unit">г</span></span>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Вертикальная группа: Энергетическая ценность, Вода, Витаминоподобные вещества, Другие компоненты -->
                        {% if product.energy_value or product.water or product.vitamin_like or product.other.oths %}
                        <div class="nutrient-category-group">
                            <!-- Энергетическая ценность -->
                            {% if product.energy_value %}
                            <div class="nutrient-category">
                                <h2 class="category-header">
                                    <span class="nutrient-name">Энергетическая ценность</span>
                                </h2>
                                <div class="nutrient-amount">{{ product.energy_value|default(0)|round(2) }} <span class="unit">ккал</span></div>
                            </div>
                            {% endif %}

                            <!-- Вода -->
                            {% if product.water %}
                            <div class="nutrient-category">
                                <h2 class="category-header">
                                    <span class="nutrient-name">Вода</span>
                                </h2>
                                <div class="nutrient-amount">{{ product.water|default(0)|round(2) }} <span class="unit">г</span></div>
                            </div>
                            {% endif %}

                            <!-- Витаминоподобные вещества -->
                            {% if product.vitamin_like and product.vitamin_like.vitslk|selectattr('amount', 'defined')|selectattr('amount', 'ne', 0)|list|length > 0 %}
                            <div class="nutrient-category">
                                <h2 class="category-header">
                                    <span class="nutrient-name">Витаминоподобные вещества</span>
                                </h2>
                                <div class="sub-category">
                                    <div class="ms-3">
                                        {% for substance in product.vitamin_like.vitslk %}
                                            {% if substance.amount|default(0) != 0 %}
                                            <div class="nutrient-item">
                                                <span class="nutrient-name">{{ substance.name }}:</span>
                                                <span class="nutrient-amount">
                                                    {{ substance.amount }} <span class="unit">{{ substance.unit }}</span>
                                                    {% if substance.rda %}<span class="text-muted small">({{ substance.rda }}%)</span>{% endif %}
                                                </span>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Другие компоненты -->
                            {% if product.other.oths and product.other.oths|selectattr('amount', 'defined')|selectattr('amount', 'ne', 0)|list|length > 0 %}
                            <div class="nutrient-category">
                                <h2 class="category-header">
                                    <span class="nutrient-name">Другие компоненты</span>
                                </h2>
                                <div class="sub-category">
                                    <div class="ms-3">
                                        {% for item in product.other.oths %}
                                            {% if item.amount %}
                                            <div class="nutrient-item">
                                                <span class="nutrient-name">{{ item.name }}:</span>
                                                <span class="nutrient-amount">
                                                    {{ item.amount }} <span class="unit">{{ item.unit }}</span>
                                                    {% if item.rda %}<span class="text-muted small">({{ item.rda }}%)</span>{% endif %}
                                                </span>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Витамины -->
                        {% if product.vitamins and product.vitamins.vits|selectattr('amount', 'defined')|selectattr('amount', 'ne', 0)|list|length > 0 %}
                        <div class="nutrient-category">
                            <h2 class="category-header">
                                <span class="nutrient-name">Витамины</span>
                            </h2>
                            <div class="sub-category">
                                <div class="ms-3">
                                    {% for vitamin in product.vitamins.vits %}
                                        {% if vitamin.amount|default(0) != 0 %}
                                        <div class="nutrient-item">
                                            <span class="nutrient-name">{{ vitamin.name }}:</span>
                                            <span class="nutrient-amount">
                                                {{ vitamin.amount }} <span class="unit">{{ vitamin.unit }}</span>
                                                {% if vitamin.rda %}<span class="text-muted small">({{ vitamin.rda }}%)</span>{% endif %}
                                            </span>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Минералы -->
                        {% set has_macro = product.minerals.macro|selectattr('amount', 'defined')|selectattr('amount', 'ne', 0)|list|length > 0 %}
                        {% set has_micro = product.minerals.micro|selectattr('amount', 'defined')|selectattr('amount', 'ne', 0)|list|length > 0 %}
                        {% if product.minerals and (has_macro or has_micro) %}
                        <div class="nutrient-category mineral-category{% if not has_macro or not has_micro %} single-mineral{% endif %}">
                            <h2 class="category-header">
                                <span class="nutrient-name">Минералы</span>
                            </h2>
                            <div class="mineral-grid">
                                {% if has_macro %}
                                <div class="sub-category macro-minerals">
                                    <h5 class="mb-3">Макроэлементы</h5>
                                    <div class="ms-3 mineral-content">
                                        {% for mineral in product.minerals.macro %}
                                        {% if mineral.amount|default(0) != 0 %}
                                        <div class="nutrient-item">
                                            <span class="nutrient-name">{{ mineral.name }}:</span>
                                            <span class="nutrient-amount">{{ mineral.amount }} <span class="unit">{{ mineral.unit }}</span></span>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                {% if has_micro %}
                                <div class="sub-category micro-minerals">
                                    <h5 class="mb-3">Микроэлементы</h5>
                                    <div class="ms-3 mineral-content">
                                        {% for mineral in product.minerals.micro %}
                                        {% if mineral.amount|default(0) != 0 %}
                                        <div class="nutrient-item">
                                            <span class="nutrient-name">{{ mineral.name }}:</span>
                                            <span class="nutrient-amount">{{ mineral.amount }} <span class="unit">{{ mineral.unit }}</span></span>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}